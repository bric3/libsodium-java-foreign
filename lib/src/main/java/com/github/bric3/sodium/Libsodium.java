/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package com.github.bric3.sodium;

import com.github.bric3.libsodium.sodium_h;
import jdk.incubator.foreign.*;

import java.lang.invoke.MethodHandle;
import java.lang.invoke.MethodType;
import java.nio.charset.Charset;
import java.nio.charset.StandardCharsets;
import java.nio.file.Path;

import static jdk.incubator.foreign.CLinker.*;
import static jdk.incubator.foreign.ValueLayout.ADDRESS;
import static jdk.incubator.foreign.ValueLayout.JAVA_BYTE;
import static jdk.incubator.foreign.ValueLayout.JAVA_CHAR;
import static jdk.incubator.foreign.ValueLayout.JAVA_INT;
import static jdk.incubator.foreign.ValueLayout.JAVA_LONG;

/**
 * On macos when the library is installed via brew, there is a symlink
 * in the <code>/usr/local/opt</code> folder.
 *
 * <pre><code>
 * $ brew install libsodium
 * $ ls -lh /usr/local/Cellar/libsodium/1.0.18_1/lib/libsodium.23.dylib
 * .r--r--r--  352k bric3 16 Feb 22:16  /usr/local/Cellar/libsodium/1.0.18_1/lib/libsodium.23.dylib
 * $ ls -lh /usr/local/opt/libsodium/lib/libsodium.23.dylib
 * .r--r--r--  352k bric3 16 Feb 22:16  /usr/local/opt/libsodium/lib/libsodium.23.dylib
 * </code></pre>
 *
 *
 */
public class Libsodium {

    private final SymbolLookup libsodiumLookup;

//    static SymbolLookup lookup() {
//        SymbolLookup loaderLookup = SymbolLookup.loaderLookup();
//        SymbolLookup systemCLinker = CLinker.systemCLinker();
//        return name -> loaderLookup.lookup(name).or(() -> systemCLinker.lookup(name));
//    }

    private Libsodium(String libraryName) {
        System.loadLibrary("sodium");
        libsodiumLookup = SymbolLookup.loaderLookup();
    }

    private Libsodium(Path libsodiumPath) {
        System.load(libsodiumPath.toAbsolutePath().toString());
        libsodiumLookup = SymbolLookup.loaderLookup();
    }

    private Libsodium(SymbolLookup libsodiumLookup) {
        this.libsodiumLookup = libsodiumLookup;
    }

    /**
     * Library name.
     * <p>
     * The given name will be mapped internally by
     * {@code java.lang.System#mapLibraryName(java.lang.String)},
     * that means it should be the name without <code>JNI_PREFIX</code>
     * and <code>JNI_SUFFIX</code> which are platform sensitive.
     *
     * @param libraryName The library name
     */
    public static Libsodium withName(String libraryName) {
        return new Libsodium(libraryName);
    }

    /**
     * Library path.
     *
     * @param libsodiumPath The path to the library
     */
    public static Libsodium withPath(Path libsodiumPath) {
        return new Libsodium(libsodiumPath);
    }

    /**
     * Library path.
     *
     * @param symbolLookup The path to the library
     */
    public static Libsodium withLookup(SymbolLookup symbolLookup) {
        return new Libsodium(symbolLookup);
    }

    public Libsodium ofJextract() {
        System.getLogger("libsodium").log(System.Logger.Level.INFO,
                                          """
                                          Make sure libsodium is available, possibly by
                                            - setting the system property 'java.library.path'
                                            - setting the environment variable 'JAVA_LIBRARY_PATH'
                                            
                                          Current java.library.path
                                          """
                                          + System.getProperty("java.library.path")
                                          + "\nCurrent JAVA_LIBRARY_PATH"
                                          + System.getenv("JAVA_LIBRARY_PATH"));

        return new JextractedLibsodium(libsodiumLookup);
    }


    public int crypto_box_sealbytes() throws Throwable {
        // size_t crypto_box_sealbytes(void);
        MethodHandle crypto_box_sealbytes =
                CLinker.systemCLinker()
                       .downcallHandle(
                               libsodiumLookup.lookup("crypto_box_sealbytes").get(),
                               FunctionDescriptor.of(JAVA_INT)
                       );

        return (int) crypto_box_sealbytes.invokeExact();
    }

    public int crypto_box_publickeybytes() throws Throwable {
        // size_t  crypto_box_publickeybytes(void);
        MethodHandle crypto_box_sealbytes =
                CLinker.systemCLinker()
                       .downcallHandle(
                               libsodiumLookup.lookup("crypto_box_publickeybytes").get(),
                               FunctionDescriptor.of(JAVA_INT)
                       );

        return (int) crypto_box_sealbytes.invokeExact();
    }

    public int crypto_box_secretkeybytes() throws Throwable {
        // crypto_box_secretkeybytes(void);
        MethodHandle crypto_box_sealbytes =
                CLinker.systemCLinker()
                       .downcallHandle(
                               libsodiumLookup.lookup("crypto_box_secretkeybytes").get(),
                               FunctionDescriptor.of(JAVA_INT)
                       );

        return (int) crypto_box_sealbytes.invokeExact();
    }

    public CryptoBoxKeyPair crypto_box_keypair() throws Throwable {
        // int crypto_box_keypair(unsigned char *pk, unsigned char *sk)
        // __attribute__ ((nonnull));

        MethodHandle crypto_box_keypair =
                CLinker.systemCLinker().downcallHandle(
                        libsodiumLookup.lookup("crypto_box_keypair").get(),
                        FunctionDescriptor.ofVoid(ADDRESS, ADDRESS)
                );

        try (var scope = ResourceScope.newConfinedScope()) {
            var segmentAllocator = SegmentAllocator.nativeAllocator(scope);
            var recipientPublicKey = segmentAllocator.allocate(crypto_box_publickeybytes());
            var recipientSecretKey = segmentAllocator.allocate(crypto_box_secretkeybytes());

            crypto_box_keypair.invoke(recipientPublicKey.address(),
                                           recipientSecretKey.address());

            return new CryptoBoxKeyPair(
                    recipientPublicKey.toArray(JAVA_BYTE),
                    recipientSecretKey.toArray(JAVA_BYTE)
            );
        }
    }


    public byte[] crypto_box_seal(String message,
                                  byte[] publicKey
    ) throws Throwable {
        var crypto_box_seal = CLinker.systemCLinker().downcallHandle(
                libsodiumLookup.lookup("crypto_box_seal").get(),
                // src/libsodium/include/sodium/crypto_box.h
                // SODIUM_EXPORT
                // int crypto_box_seal(unsigned char *c, const unsigned char *m,
                //                    unsigned long long mlen, const unsigned char *pk)
                //            __attribute__ ((nonnull(1, 4)));
                //
                // "(
                //   Ljdk/incubator/foreign/MemoryAddress;
                //   Ljdk/incubator/foreign/MemoryAddress;
                //   J
                //   Ljdk/incubator/foreign/MemoryAddress;
                // )"
                //
                // c.address(), m.address(), mlen, pk.address()
                FunctionDescriptor.of(JAVA_INT,
                                      ADDRESS,
                                      ADDRESS,
                                      JAVA_LONG,
                                      ADDRESS)

        );

        try (var scope = ResourceScope.newConfinedScope()) {
            var segmentAllocator = SegmentAllocator.nativeAllocator(scope);
            var nativeMessage = segmentAllocator.allocateUtf8String(message);
            var cipherText = segmentAllocator.allocate(crypto_box_sealbytes() + nativeMessage.byteSize());
            var ret = (int) crypto_box_seal.invoke(
                    cipherText.address(),
                    nativeMessage.address(),
                    (long) nativeMessage.byteSize(),
                    segmentAllocator.allocateArray(JAVA_BYTE, publicKey).address());
            return cipherText.toArray(JAVA_BYTE);
        }
    }

    public String crypto_box_seal_open(byte[] cipherText,
                                       byte[] publicKey,
                                       byte[] secretKey
    ) throws Throwable {

        var crypto_box_seal_open = systemCLinker().downcallHandle(
                libsodiumLookup.lookup("crypto_box_seal_open").get(),
                // "(Ljdk/incubator/foreign/MemoryAddress;
                //   Ljdk/incubator/foreign/MemoryAddress;
                //   J
                //   Ljdk/incubator/foreign/MemoryAddress;
                //   Ljdk/incubator/foreign/MemoryAddress;)I"
                FunctionDescriptor.of(JAVA_INT,
                                      ADDRESS,
                                      ADDRESS,
                                      JAVA_LONG,
                                      ADDRESS,
                                      ADDRESS
                )
        );

        try (var scope = ResourceScope.newConfinedScope()) {
            var segmentAllocator = SegmentAllocator.newNativeArena(scope);
            var decipheredText = segmentAllocator.allocateArray(JAVA_CHAR, cipherText.length - crypto_box_sealbytes());
            var ret = (int) crypto_box_seal_open.invoke(decipheredText.address(),
                                                             segmentAllocator.allocateArray(JAVA_BYTE, cipherText).address(),
                                                             (long) cipherText.length,
                                                             segmentAllocator.allocateArray(JAVA_BYTE, publicKey).address(),
                                                             segmentAllocator.allocateArray(JAVA_BYTE, secretKey).address());

            return decipheredText.getUtf8String(0);
        }
    }

    public long JAVA_strlen_smokeTest(String str, Charset charset) throws Throwable {
        MethodHandle strlen = CLinker.systemCLinker()
                                     .downcallHandle(
                                             CLinker.systemCLinker().lookup("strlen").get(),
                                             FunctionDescriptor.of(JAVA_LONG, ADDRESS)
                                     );

        try (var scope = ResourceScope.newConfinedScope()) {
            var segmentAllocator = SegmentAllocator.newNativeArena(scope);
            return (long) strlen.invokeExact(segmentAllocator.allocateUtf8String(str).address());
        }
    }



    private class JextractedLibsodium extends Libsodium {
        private JextractedLibsodium(String libraryName) {
            super(libraryName);
        }

        private JextractedLibsodium(Path libsodiumPath) {
            super(libsodiumPath);
        }

        public JextractedLibsodium(SymbolLookup libsodiumLookup) {
            super(libsodiumLookup);
        }


        @Override
        public CryptoBoxKeyPair crypto_box_keypair() {
            try (var scope = ResourceScope.newConfinedScope()) {
                var segmentAllocator = SegmentAllocator.nativeAllocator(scope);
                var recipientPublicKey = segmentAllocator.allocate(sodium_h.crypto_box_PUBLICKEYBYTES());
                var recipientSecretKey = segmentAllocator.allocate(sodium_h.crypto_box_SECRETKEYBYTES());

                sodium_h.crypto_box_keypair(recipientPublicKey, recipientSecretKey);

                return new CryptoBoxKeyPair(
                        recipientPublicKey.toArray(JAVA_BYTE),
                        recipientSecretKey.toArray(JAVA_BYTE)
                );
            }
        }

        @Override
        public byte[] crypto_box_seal(String message,
                                      byte[] publicKey) {
            try (var scope = ResourceScope.newConfinedScope()) {
                var segmentAllocator = SegmentAllocator.nativeAllocator(scope);
                var nativeMessage = segmentAllocator.allocateUtf8String(message);
                var cipherText = segmentAllocator.allocate(sodium_h.crypto_box_SEALBYTES() + nativeMessage.byteSize());
                sodium_h.crypto_box_seal(cipherText.address(),
                                         nativeMessage.address(),
                                         nativeMessage.byteSize(),
                                         segmentAllocator.allocateArray(JAVA_BYTE, publicKey).address());
                return cipherText.toArray(JAVA_BYTE);
            }
        }

        public String crypto_box_seal_open(byte[] cipherText,
                                           byte[] publicKey,
                                           byte[] secretKey) {
            try (var scope = ResourceScope.newConfinedScope()) {
                var segmentAllocator = SegmentAllocator.nativeAllocator(scope);
                var decipheredText = segmentAllocator.allocateArray(JAVA_BYTE, cipherText.length - sodium_h.crypto_box_SEALBYTES());
                sodium_h.crypto_box_seal_open(decipheredText.address(),
                                              segmentAllocator.allocateArray(JAVA_BYTE, cipherText).address(),
                                              cipherText.length,
                                              segmentAllocator.allocateArray(JAVA_BYTE, publicKey).address(),
                                              segmentAllocator.allocateArray(JAVA_BYTE, secretKey).address());

                return decipheredText.getUtf8String(0);
            }
        }
    }
}
